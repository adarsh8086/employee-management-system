<!doctype html>
<html>
<head>
  <title>Form Builder</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    .field { border:1px solid #ddd; padding:8px; margin-bottom:6px; background:#fff; }
    .field input, .field select { margin-right:6px; }
  </style>
</head>
<body>
  <h2>Create / Edit Form</h2>
  <input id="formName" placeholder="Form name">
  <input id="formSlug" placeholder="slug (unique)">

  <div id="fieldsList"></div>

  <button id="addField">Add Field</button>
  <button id="saveForm">Save Form</button>
  <button id="loginBtn">Login</button>


  <template id="fieldTpl">
    <div class="field">
      <input class="label" placeholder="Label (e.g. Full Name)">
      <input class="name" placeholder="name (machine e.g. full_name)">
      <select class="type">
        <option value="text">Text</option>
        <option value="number">Number</option>
        <option value="date">Date</option>
        <option value="password">Password</option>
        <option value="email">Email</option>
        <option value="textarea">Textarea</option>
      </select>
      <label><input type="checkbox" class="required"> required</label>
      <button class="remove">Remove</button>
    </div>
  </template>


<script>
const token = localStorage.getItem('access'); // JWT token
const fieldsList = document.getElementById('fieldsList');
const tpl = document.getElementById('fieldTpl').content;

// Login button
document.getElementById('loginBtn').addEventListener('click', () => {
  window.location.href = '/accounts/login-page/';
});

// Add field
document.getElementById('addField').addEventListener('click', () => {
  const node = document.importNode(tpl, true);
  node.querySelector('.remove').addEventListener('click', e => e.target.closest('.field').remove());
  fieldsList.appendChild(node);
});

// Enable drag/drop
Sortable.create(fieldsList, { animation: 150 });

// Save form
document.getElementById('saveForm').addEventListener('click', async () => {
  const name = document.getElementById('formName').value;
  const slug = document.getElementById('formSlug').value;

  const fieldNodes = fieldsList.querySelectorAll('.field');
  const fields = Array.from(fieldNodes).map((el, index) => ({
    label: el.querySelector('.label').value,
    name: el.querySelector('.name').value,
    field_type: el.querySelector('.type').value,
    required: el.querySelector('.required').checked
}));


  try {
    // Correct API endpoint
    const res = await axios.post('/api/forms/forms/', { name, slug, fields }, {
      headers: { Authorization: `Bearer ${token}` }
    });
    alert('Form saved âœ…');
    const newFormId = res.data.id;
   window.location.href = `/employees/create/?form=${newFormId}`;


  } catch (err) {
    console.error(err);

    // Proper error message
    let msg;
    if (err.response) {
      msg = typeof err.response.data === 'object'
        ? JSON.stringify(err.response.data, null, 2)
        : err.response.data;
    } else {
      msg = err.message;
    }
    alert('Error: ' + msg);
  }
});
</script>

</body>
</html>
